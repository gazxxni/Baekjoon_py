name: Update Blog Post to Another Repo

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Move files under auto_upload"]
    types:
      - completed

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }} 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install Dependencies
        run: |
          pip install requests beautifulsoup4 openai
      
      - name: Run Converter Script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python convert.py
      
      - name: Check if blog_posts exists
        id: check_folder
        run: |
          if [ -d "blog_posts" ] && [ "$(ls -A blog_posts)" ]; then
            echo "has_posts=true" >> $GITHUB_OUTPUT
          else
            echo "has_posts=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Pushes to Blog Repository
        if: steps.check_folder.outputs.has_posts == 'true'
        env:
          DEST_REPO: 'gazxxni/gazxxni.github.io' 
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        run: |
          # 1. ë¸”ë¡œê·¸ ë¦¬í¬ì§€í† ë¦¬ ë‹¤ìš´ë¡œë“œ (ê¸°ì¡´ íŒŒì¼ í™•ì¸ìš©)
          git clone https://x-access-token:$API_TOKEN_GITHUB@github.com/$DEST_REPO.git destination_repo
          mkdir -p destination_repo/_posts
          
          # 2. [í•µì‹¬ ë¡œì§] ì¤‘ë³µ ê²€ì‚¬ í›„ ë³µì‚¬
          # blog_posts í´ë”ì˜ íŒŒì¼ë“¤ì„ í•˜ë‚˜ì”© ê²€ì‚¬í•©ë‹ˆë‹¤.
          cd blog_posts
          for file in *.md; do
            # íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•  ë•Œë§Œ ì‹¤í–‰
            [ -e "$file" ] || continue
            
            # íŒŒì¼ëª…ì—ì„œ ë‚ ì§œë¥¼ ì œì™¸í•œ ë’·ë¶€ë¶„(baekjoon-ë²ˆí˜¸.md)ì„ ì¶”ì¶œ
            # ì˜ˆ: 2026-01-15-baekjoon-2887.md -> baekjoon-2887.md
            identifier=$(echo "$file" | sed -E 's/^[0-9]{4}-[0-9]{2}-[0-9]{2}-//')
            
            # ë¸”ë¡œê·¸ í´ë”(_posts)ì— ê°™ì€ ë²ˆí˜¸ì˜ ë¬¸ì œê°€ ì´ë¯¸ ìˆëŠ”ì§€ ê²€ì‚¬
            if ls ../destination_repo/_posts/*$identifier 1> /dev/null 2>&1; then
              echo "âš ï¸ ì¤‘ë³µ ê±´ë„ˆëœ€ (ì´ë¯¸ ì¡´ì¬í•¨): $file"
            else
              echo "âœ… ìƒˆ ê¸€ ì—…ë¡œë“œ: $file"
              cp "$file" ../destination_repo/_posts/
            fi
          done
          cd ..
          
          # 3. ë³€ê²½ ì‚¬í•­ ë°˜ì˜
          cd destination_repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add _posts/
          git diff --staged --quiet || git commit -m "ğŸ§© Update new algorithm solution only"
          git push origin main
