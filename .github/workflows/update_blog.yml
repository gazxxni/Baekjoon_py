name: Update Blog Post to Another Repo

on:
  # 1. 수동 실행 가능 (테스트용)
  workflow_dispatch:
  
  # 2. 'Move files...' 액션이 끝나면 자동으로 이어서 실행 (핵심!)
  workflow_run:
    workflows: ["Move files under auto_upload"]  # 앞선 워크플로우의 정확한 이름
    types:
      - completed

jobs:
  build:
    # 앞선 액션이 '성공'했을 때만 실행
    if: ${{ github.event.workflow_run.conclusion == 'success' }} 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ... (이하 steps 내용은 기존과 동일하게 유지) ...
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install Dependencies
        run: |
          pip install requests beautifulsoup4 openai
      
      - name: Run Converter Script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python convert.py
      
      - name: Check if blog_posts exists
        id: check_folder
        run: |
          if [ -d "blog_posts" ] && [ "$(ls -A blog_posts)" ]; then
            echo "has_posts=true" >> $GITHUB_OUTPUT
          else
            echo "has_posts=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Pushes to Blog Repository
        if: steps.check_folder.outputs.has_posts == 'true'
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: 'blog_posts'
          destination-github-username: 'gazxxni'
          destination-repository-name: 'gazxxni.github.io'
          user-email: 'action@github.com'
          target-branch: 'main'
          target-directory: '_posts'
