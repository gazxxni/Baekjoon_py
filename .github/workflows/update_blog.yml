name: Update Blog Post to Another Repo

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Move files under auto_upload"]
    types:
      - completed

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }} 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install Dependencies
        run: |
          pip install requests beautifulsoup4 openai
      
      - name: Run Converter Script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python convert.py
      
      - name: Check if blog_posts exists
        id: check_folder
        run: |
          if [ -d "blog_posts" ] && [ "$(ls -A blog_posts)" ]; then
            echo "has_posts=true" >> $GITHUB_OUTPUT
          else
            echo "has_posts=false" >> $GITHUB_OUTPUT
          fi
      
      # [í•µì‹¬ ë³€ê²½] ê¸°ì¡´ ì•¡ì…˜ì„ ì§€ìš°ê³ , ì•ˆì „í•˜ê²Œ 'Clone -> Copy -> Push' í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¡œ ë³€ê²½
      - name: Pushes to Blog Repository
        if: steps.check_folder.outputs.has_posts == 'true'
        env:
          # ë¸”ë¡œê·¸ ë¦¬í¬ì§€í† ë¦¬ ì£¼ì†Œ (ë³¸ì¸ ì•„ì´ë””/ë¦¬í¬ì§€í† ë¦¬ëª… í™•ì¸ í•„ìˆ˜)
          DEST_REPO: 'gazxxni/gazxxni.github.io' 
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        run: |
          # 1. ë¸”ë¡œê·¸ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ì‹œ í´ë”(destination_repo)ì— ë‹¤ìš´ë¡œë“œ(Clone)
          git clone https://x-access-token:$API_TOKEN_GITHUB@github.com/$DEST_REPO.git destination_repo
          
          # 2. ìƒˆë¡œ ìƒì„±ëœ íŒŒì¼ë“¤ì„ ë¸”ë¡œê·¸ í´ë”(_posts)ë¡œ ë³µì‚¬
          # -r: í´ë” ë‚´ë¶€ê¹Œì§€, -u: ì—†ê±°ë‚˜ ë” ìµœì‹  íŒŒì¼ì¼ ë•Œë§Œ ë³µì‚¬ (ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ì•ˆ í•¨!)
          mkdir -p destination_repo/_posts
          cp -r -u blog_posts/* destination_repo/_posts/
          
          # 3. ë³€ê²½ ì‚¬í•­ì„ ë¸”ë¡œê·¸ ë¦¬í¬ì§€í† ë¦¬ì— ë°˜ì˜
          cd destination_repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add _posts/
          
          # ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹í•˜ê³  í‘¸ì‹œ (ì—ëŸ¬ ë°©ì§€)
          git diff --staged --quiet || git commit -m "ğŸ§© Update algorithm solution post"
          git push origin main
